<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Andrea Piseri">
<title>Just cos</title>
<style>
@charset "UTF-8";

@import "https://cdn.jsdelivr.net/gh/bitmaks/cm-web-fonts@latest/fonts.css";

html {
	background: #f7f7f7;
	color: #282828;
	padding: 0;
	margin: 0;
	height: 100%;
}

#header {
	padding-top: 1px;
	margin-top: -1px;
	text-align: center;
	.details {
		display: flex;
		flex-flow: row;
		max-width: fit-content;
		margin-left:auto;
		margin-right:auto;
		br + span::before {
			margin: 1em;
			content: "-";
		}
	}
	width: none;
	background: #eaeaea;
	border-bottom: 1px solid;
}

#toc {
	border-bottom: 1px solid;
	padding-bottom:0.5em;
}

#content {
	width: 80%;
	max-width: 80em;
	margin-left: auto;
	margin-right: auto;
}

#footer {
	bottom:0;
	margin-top: auto;
	border-top: 1px solid;
	max-width: none;
	background: #f0f0f0;
	padding: 1em;
}

body {
	display: flex;
	flex-direction:column;
	padding: 0;
	margin: 0;
	min-height: 100%;
	font-family: Computer Modern Concrete, Georgia, serif;
}

table {
	background: #eaeaea;
	border-collapse: collapse;
	border-radius: 5px;
	border-bottom: 1px solid;
	border-top: 2px solid;
}

th {
	border-bottom: 1px solid;
}

tr {
	padding-left: 20px;
	padding-right: 20px;
}

tbody td {
	padding-left: 10px;
	padding-right: 10px;
}

td p {
	margin: 5px;
	margin: 5px;
}

pre {
	white-space: pre;
	background: #eaeaea !important;
	overflow-x: auto;
	border-radius: 5px;
	padding: 1em;
}

:not(pre) > code {
	background: #eaeaea;
	border-radius: 5px;
}

</style>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Just <code>cos</code></h1>
<div class="details">
<span id="author" class="author">Andrea Piseri</span><br>
<span id="email" class="email"><a href="mailto:andrea.piseri@gmail.com">andrea.piseri@gmail.com</a></span><br>
<span id="revdate">20/06/2023</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Lessons learned implementing trig functions without floating point numbers</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notation">Notation:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>\(\sin\) and \(\cos\) are mathematical functions taking the argument in radians</p>
</li>
<li>
<p>\(\text{tsin}\) and \(\text{tcos}\) are mathematical functions taking the argument in turns</p>
</li>
<li>
<p><code>sin</code> and <code>cos</code>   are the <code>C</code> functions that calculate \(\sin\) and \(\cos\) on <code>double</code>s</p>
</li>
<li>
<p><code>tsin</code> and <code>tcos</code> are the <code>C</code> functions that calculate \(\text{tsin}\) and \(\text{tcos}\) on <code>double</code>s</p>
</li>
<li>
<p><code>isin</code> and <code>icos</code> are the <code>C</code> functions that calculate \(\text{tsin}\) and \(\text{tcos}\) on fixed point numbers</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_choosing_turns_over_radians">Choosing turns over radians</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a tough decision for a mathematician to do, but \(\pi\) is irrational and
computer numbers are rationals. What&#8217;s more, they are (almost always) multiples
of a power of 2. This means that, in floating point numbers of <em>any</em>
precision, <code>sin</code>\((\pi) \ne 0\), because the argument is rounded before being
passed to the function. If we use turns, though, more of the meaningful angles
are exactly representable: <code>tsin</code>\((\frac 1 2) = 0\); in fact, \(\forall n \in \mathbb{N}\),
<code>tsin</code>\((\frac n 2) = 0\) and <code>tcos</code>\((\frac n 2) = \pm 1\),
always, with exactly zero error, as at worst the input will be rounded towards the
nearest integer.</p>
</div>
<div class="paragraph">
<p>Moreover (and this is completely anecdotal) the most common operation that a
user does before feeding an exact value to <code>sin</code> or <code>cos</code> is likely to multiply
it by some integer multiple of \(\pi\), and the first thing that (at least some)
mathematical library does is immediately divide by \(2\pi\).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_polynomial_interpolation">Polynomial interpolation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A common strategy for evaluating transcendental functions on computer hardware
is to find a good enough interpolating polynomial for a small subset of the
function&#8217;s domain, and then to refer the other values back to that subset by
some symmetry.</p>
</div>
<div class="paragraph">
<p>For our purposes, we will first focus on finding an interpolating polynomial
for the \(\cos\) function on the range \([-\frac\pi 4, \frac\pi 4)\) (or rather for
the \(\text{tcos}\) function on the corresponding range \([-\frac 1 8, \frac 1 8)\)).
Then the \(\text{tcos}\) function can be calculated by multiplying the angle by 4,
and the integer part mod 4 tells us what function to apply on the fractional part:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if \(\left\lfloor4x\right\rceil \equiv 0 \pmod{4}\),
calculate \(+\) <code>icos</code>\(\left(2^{63} \cdot 8\left(x - \frac{\left\lfloor4x\right\rceil}{4}\right)\right)\)</p>
</li>
<li>
<p>if \(\left\lfloor4x\right\rceil \equiv 1 \pmod{4}\),
calculate \(-\) <code>isin</code>\(\left(2^{63} \cdot 8\left(x - \frac{\left\lfloor4x\right\rceil}{4}\right)\right)\)</p>
</li>
<li>
<p>if \(\left\lfloor4x\right\rceil \equiv 2 \pmod{4}\),
calculate \(-\) <code>icos</code>\(\left(2^{63} \cdot 8\left(x - \frac{\left\lfloor4x\right\rceil}{4}\right)\right)\)</p>
</li>
<li>
<p>if \(\left\lfloor4x\right\rceil \equiv 3 \pmod{4}\),
calculate \(+\) <code>isin</code>\(\left(2^{63} \cdot 8\left(x - \frac{\left\lfloor4x\right\rceil}{4}\right)\right)\)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We want a few good properties of this polynomial; first, we want it to be a close approximation,
which means that for all values of \(x \in [-\frac 1 8, \frac 1 8)\), the absolute error
\(|p(x) - \text{tcos}(x)|\) is smaller than some defined threshold. Since the goal is implementing
trigonometric functions for posit arithmetic, we&#8217;re looking for an error in the order of \(2^{-61}\),
which corresponds to about 1ULP (unit in last place) for the posit value \(\frac{\sqrt{2}}{2}\)
(which is the smallest output value we need to care about); this also means that we need to do significantly
better than <code>double</code> precision arithmetic, which only has 53 bits of precision and as such can get away with
an error below \(2^{-54}\).</p>
</div>
<div class="paragraph">
<p>Second, we want it to be cheap to evaluate: for polynomials this means to have as small of a degree as possible,
in our case a degree 14 polynomial is enough, however the terms of odd degree will be zero due to \(\text{tcos}\)
being an even function, and only 6 terms (plus the constant term) will be used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_im_going_to_be_real_with_you_chief_im_not_doing_that_by_hand">I&#8217;m going to be real with you chief, I&#8217;m not doing that by hand.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Obviously, finding the best polynomial to approximate \(\text{tcos}\) would take forever to do by hand,
considering that the coefficients need about the same number of significant digits that we want in our result.
Fortunately interpolating polynomials are very well researched, and getting a computer to do the heavy lifting
for us will be pretty easy; the first order of business is getting some accurate samples of the \(\text{tcos}\)
function.</p>
</div>
<div class="paragraph">
<p>Standing on the shoulders of giants, we know that for maximum numerical accuracy it&#8217;s a good idea <em>not</em> to use
equidistant samples, which would incur <a href="https://en.wikipedia.org/wiki/Runge%27s_phenomenon">Runge&#8217;s phenomenon</a>,
but instead to choose a set of <a href="https://en.wikipedia.org/wiki/Chebyshev_nodes">Chebyshev nodes</a>, obtained through
the formula:</p>
</div>
<div class="stemblock">
<div class="content">
\[x_k = a + (b-a) \cos\left(\frac k n \pi\right)\]
</div>
</div>
<div class="paragraph">
<p>where \([a, b]\) is the interval we want to approximate our function on.</p>
</div>
<div class="paragraph">
<p>Ok then, we ask Wolfram Alpha (which supposedly calculates \(\cos\) accurately enough for our purposes)
with a series of queries like this:</p>
</div>
<div class="paragraph">
<p><code>round(cos(k/14 * pi) * 2^63) for k in {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14}</code></p>
</div>
<div class="paragraph">
<p><code>round(cos(cos(k/14 * pi) * pi/4) * 2^63) for k in {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14}</code></p>
</div>
<div class="paragraph">
<p>and get back our data:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">\(x \cdot 2^{63}\)</th>
<th class="tableblock halign-left valign-top">\(y \cdot 2^{63}\)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-9223372036854775808</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6521908912666391106</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-8992122843167040398</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6649062829911898522</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-8309971062287876938</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7008946939873054357</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-7211122632928341039</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7538462657309403407</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-5750678403727967667</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8139439240617060549</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-4001871146622878209</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8693001419304471778</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-2052393359867478633</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>9082872288129848112</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+0000000000000000000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>9223372036854775808</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+2052393359867478633</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>9082872288129848112</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+4001871146622878209</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8693001419304471778</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+5750678403727967667</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8139439240617060549</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+7211122632928341039</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7538462657309403407</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+8309971062287876938</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7008946939873054357</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+8992122843167040398</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6649062829911898522</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+9223372036854775808</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6521908912666391106</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>now it&#8217;s time to do some actual math. I chose haskell as a language because it has good support for arbitrary precision
rational numbers: if any of our values so much as touch a floating point representation, we will be losing precision.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">xs&#39;</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">9223372036854775808</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mi">8992122843167040398</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mi">8309971062287876938</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mi">7211122632928341039</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mi">5750678403727967667</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mi">4001871146622878209</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mi">2052393359867478633</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">0000000000000000000</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2052393359867478633</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4001871146622878209</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">5750678403727967667</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">7211122632928341039</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">8309971062287876938</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">8992122843167040398</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">9223372036854775808</span>
<span class="tok-w">      </span><span class="tok-p">]</span>

<span class="tok-nf">ys&#39;</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mi">6521908912666391106</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">6649062829911898522</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">7008946939873054357</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">7538462657309403407</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">8139439240617060549</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">8693001419304471778</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">9082872288129848112</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">9223372036854775808</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">9082872288129848112</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">8693001419304471778</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">8139439240617060549</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">7538462657309403407</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">7008946939873054357</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">6649062829911898522</span>
<span class="tok-w">      </span><span class="tok-p">,</span><span class="tok-mi">6521908912666391106</span>
<span class="tok-w">      </span><span class="tok-p">]</span>

<span class="tok-nf">xs</span><span class="tok-ow">::</span><span class="tok-p">[</span><span class="tok-kt">Rational</span><span class="tok-p">]</span>
<span class="tok-nf">xs</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">map</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">/</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-o">^</span><span class="tok-mi">63</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-n">xs&#39;</span>

<span class="tok-nf">ys</span><span class="tok-ow">::</span><span class="tok-p">[</span><span class="tok-kt">Rational</span><span class="tok-p">]</span>
<span class="tok-nf">ys</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">map</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">/</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-o">^</span><span class="tok-mi">63</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-n">ys&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One way to find the interpolating polynomial given a set of nodes is through
<a href="https://en.wikipedia.org/wiki/Newton_polynomial#Main_idea">Newton&#8217;s polynomial</a> form:</p>
</div>
<div class="paragraph">
<p>our coefficients are the entries of a vector $\underline{c}$ such that:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
	1       &amp;0           &amp;0                      &amp;\dots  &amp;0                          \\
	1       &amp;(x_1 - x_0) &amp;0                      &amp;\dots  &amp;0                          \\
	\vdots  &amp;\vdots      &amp;\vdots                 &amp;\ddots &amp;\vdots                     \\
	1       &amp;(x_n - x_0) &amp;(x_n - x_0)(x_n - x_1) &amp;\dots  &amp;(x_n-x_0)\dots(x_n-x_{n-1})\\
\end{bmatrix}
\begin{bmatrix}
	c_0 \\ c_1 \\ \vdots \\ c_n
\end{bmatrix}
=
\begin{bmatrix}
	y_0 \\ y_1 \\ \vdots \\ y_n
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>we construct the lower triangular matrix as a list of lists (here I rounded the values for printing).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">newtonMatrix</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">map</span><span class="tok-w"> </span><span class="tok-n">row</span><span class="tok-w"> </span><span class="tok-n">xs</span>
<span class="tok-w">  </span><span class="tok-kr">where</span><span class="tok-w"> </span><span class="tok-n">row</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">takeWhile</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">/=</span><span class="tok-mi">0</span><span class="tok-p">)</span>
<span class="tok-w">              </span><span class="tok-o">.</span><span class="tok-w"> </span><span class="tok-n">scanl</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-mi">1</span>
<span class="tok-w">              </span><span class="tok-o">.</span><span class="tok-w"> </span><span class="tok-n">zipWith</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">flip</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-n">xs</span>
<span class="tok-w">              </span><span class="tok-o">.</span><span class="tok-w"> </span><span class="tok-n">repeat</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-p">[[</span><span class="tok-mf">1.0</span><span class="tok-p">]</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">2.5072087818176395e-2</span><span class="tok-p">]</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">9.903113209758087e-2</span><span class="tok-p">,</span><span class="tok-mf">7.324247883844538e-3</span><span class="tok-p">]</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">0.2181685175319702</span><span class="tok-p">,</span><span class="tok-mf">4.212756181137467e-2</span><span class="tok-p">,</span><span class="tok-mf">5.0189675689328046e-3</span><span class="tok-p">]</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">0.37651019814126646</span><span class="tok-p">,</span><span class="tok-mf">0.13232003255213892</span><span class="tok-p">,</span><span class="tok-mf">3.671603905143758</span><span class="tok-n">e</span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-o">...</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">0.5661162608824418</span><span class="tok-p">,</span><span class="tok-mf">0.30629390422737474</span><span class="tok-p">,</span><span class="tok-mf">0.1430653277020612</span><span class="tok-p">,</span><span class="tok-mi">4</span><span class="tok-w"> </span><span class="tok-o">...</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">0.7774790660436856</span><span class="tok-p">,</span><span class="tok-mf">0.5849806747155206</span><span class="tok-p">,</span><span class="tok-mf">0.3968789301591433</span><span class="tok-p">,</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-w"> </span><span class="tok-o">...</span>
<span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">1.0</span><span class="tok-p">,</span><span class="tok-mf">0.9749279121818236</span><span class="tok-p">,</span><span class="tok-mf">0.8783796973249267</span><span class="tok-p">,</span><span class="tok-mf">0.686744900929366</span><span class="tok-w"> </span><span class="tok-o">...</span>
<span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then the coefficients to Newton&#8217;s form can be obtained by solving the triangular system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">newtonCoeff</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">zipWith</span><span class="tok-w"> </span><span class="tok-n">fn</span><span class="tok-w"> </span><span class="tok-n">newtonMatrix</span><span class="tok-w"> </span><span class="tok-n">ys</span>
<span class="tok-w">  </span><span class="tok-kr">where</span><span class="tok-w"> </span><span class="tok-n">fn</span><span class="tok-w"> </span><span class="tok-n">row</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">init</span><span class="tok-w"> </span><span class="tok-n">row</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">`</span><span class="tok-n">dot</span><span class="tok-p">`</span><span class="tok-w"> </span><span class="tok-n">newtonCoeff</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">last</span><span class="tok-w"> </span><span class="tok-n">row</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">as</span><span class="tok-w"> </span><span class="tok-p">`</span><span class="tok-n">dot</span><span class="tok-p">`</span><span class="tok-w"> </span><span class="tok-n">bs</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">sum</span><span class="tok-w"> </span><span class="tok-o">$</span><span class="tok-w"> </span><span class="tok-n">zipWith</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">as</span><span class="tok-w"> </span><span class="tok-n">bs</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-p">[</span><span class="tok-mf">0.7071067811865476</span><span class="tok-p">,</span><span class="tok-mf">0.5498566944938549</span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mf">0.22502818791042026</span><span class="tok-p">,</span><span class="tok-o">-</span><span class="tok-mf">5.31</span><span class="tok-w"> </span><span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>these are not particularly comfortable to use in our case though, because the evaluation formula
for newton&#8217;s polynomial still involves the sample positions \(x_0 \dots x_n\):</p>
</div>
<div class="stemblock">
<div class="content">
\[P(x) = \sum_{i=0}^n \left(c_j \prod_{j=0}^{i-1} (x - x_j)\right)\]
</div>
</div>
<div class="paragraph">
<p>in order to get a cheaper evaluation formula, we can rewrite the equation in the
following form and distribute the products to get the power series form of the
polynomial:</p>
</div>
<div class="stemblock">
<div class="content">
\[P(x) = c_0 + (x - x_0)(c_1 + (x - x_1)(c_2 + (x - x_2)(\dots + (x - x_{n-1})c_n\dots))).\]
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">powerSeries</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">c</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-kr">_</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-n">c</span><span class="tok-p">]</span>
<span class="tok-nf">powerSeries</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-kt">:</span><span class="tok-n">cs</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-kt">:</span><span class="tok-n">xs</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-o">+</span><span class="tok-n">const</span><span class="tok-p">)</span><span class="tok-kt">:</span><span class="tok-n">rest</span>
<span class="tok-w">  </span><span class="tok-kr">where</span><span class="tok-w"> </span><span class="tok-n">psc&#39;</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">powerSeries</span><span class="tok-w"> </span><span class="tok-n">cs</span><span class="tok-w"> </span><span class="tok-n">xs</span>
<span class="tok-w">        </span><span class="tok-p">(</span><span class="tok-n">const</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">zipWith</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-kt">:</span><span class="tok-n">psc&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">$</span><span class="tok-w"> </span><span class="tok-n">map</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">psc&#39;</span><span class="tok-o">++</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">])</span>

<span class="tok-nf">coefficients</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">powerSeries</span><span class="tok-w"> </span><span class="tok-n">newtonCoeff</span><span class="tok-w"> </span><span class="tok-n">xs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the result are coefficients \(\tilde{c}_j\) such that</p>
</div>
<div class="stemblock">
<div class="content">
\[P(x) = \sum_{j=0}^n \tilde{c}_j x^j.\]
</div>
</div>
<div class="paragraph">
<p>we can print our result, converted to fixnum:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">main</span><span class="tok-w"> </span><span class="tok-ow">=</span><span class="tok-w"> </span><span class="tok-n">mapM</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">print</span><span class="tok-w"> </span><span class="tok-o">.</span><span class="tok-w"> </span><span class="tok-n">round</span><span class="tok-w"> </span><span class="tok-o">.</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-o">^</span><span class="tok-mi">63</span><span class="tok-p">)))</span><span class="tok-w"> </span><span class="tok-n">coefficients</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>9223372036854775808
0
-2844719788994575527
0
146230515361076815
0
-3006744454122068
0
33119841825907
0
-226999764641
0
1060732338
0
-3557527</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first is the constant term, which we can verify is equal to \(2^{63}\), and represents <code>icos</code>\((0)\);
after that every other term is zero, which matches up with our prediction; the remaining terms alternate signs,
similar to the Taylor coefficients for \(\cos\)' power series. In fact, they are nearly identical accounting
for the rescaling.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_evaluating_the_polynomial">Evaluating the polynomial</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The formula we want to evaluate now is:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align}
\text{tcos}(\alpha) \sim 1
&amp;- \frac{2844719788994575527}{2^{63}} \alpha^2
+ \frac{146230515361076815} {2^{63}} \alpha^4
- \frac{3006744454122068}   {2^{63}} \alpha^6 \\
&amp;+ \frac{33119841825907}     {2^{63}} \alpha^8
- \frac{226999764641}       {2^{63}} \alpha^{10}
+ \frac{1060732338}         {2^{63}} \alpha^{12}
- \frac{3557527}            {2^{63}} \alpha^{14}
\end{align}\]
</div>
</div>
<div class="paragraph">
<p>since our input and output are fixed point numbers, what we will end up is:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align}
    \text{icos}(t) = 2^{63}
&amp;- 2844719788994575527 \left(\frac{t}{2^{63}}\right)^2
+ 146230515361076815  \left(\frac{t}{2^{63}}\right)^4
- 3006744454122068    \left(\frac{t}{2^{63}}\right)^6 \\
&amp;+ 33119841825907      \left(\frac{t}{2^{63}}\right)^8
- 226999764641        \left(\frac{t}{2^{63}}\right)^{10}
+ 1060732338          \left(\frac{t}{2^{63}}\right)^{12}
- 3557527             \left(\frac{t}{2^{63}}\right)^{14}
\end{align}\]
</div>
</div>
<div class="paragraph">
<p>Now, we obviously can&#8217;t calculate \(\frac t {2^{63}}\) right away, as that would always be \(0\) or
\(\pm 1\) when rounded to an integer and we would lose all our precision; we also would like as many
of our divisions to have a denominator of exactly \(2^{64}\), since that&#8217;s equivalent to taking the
higher word of a merged 128-bit register, which on x86_64 is very cheap (good ol' <code>_mulx_u64</code>).</p>
</div>
<div class="paragraph">
<p>we perform the following substitution:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align}
    x_2 = \frac{t^2}{2^{62}} &amp;= \left(\frac{t}{2^{63}}\right)^2 2^{64} \\
    x_{2n+2} = \frac{x_{2n} \cdot x_2}{2^{64}} &amp;= \left(\frac{t}{2^{63}}\right)^{2n+2} 2^{64} \\
    \text{icos}(t) = 2^{63}
    &amp;- \frac{x_2    \cdot 2844719788994575527}{2^{64}}
     + \frac{x_4    \cdot 146230515361076815 }{2^{64}}
     - \frac{x_6    \cdot 3006744454122068   }{2^{64}}\\
    &amp;+ \frac{x_8    \cdot 33119841825907     }{2^{64}}
     - \frac{x_{10} \cdot 226999764641       }{2^{64}}
     + \frac{x_{12} \cdot 1060732338         }{2^{64}}
     - \frac{x_{14} \cdot 3557527            }{2^{64}}
\end{align}\]
</div>
</div>
<div class="paragraph">
<p>We implement that in <code>C</code> as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-nf">icos</span><span class="tok-p">(</span><span class="tok-kt">int64_t</span><span class="tok-w"> </span><span class="tok-n">t</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">	</span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">		</span><span class="tok-mi">2844719788994575527</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">146230515361076815</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">3006744454122068</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">33119841825907</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">226999764641</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">1060732338</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">3557527</span><span class="tok-p">,</span>
<span class="tok-w">	</span><span class="tok-p">};</span>

<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x2</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">int128_t</span><span class="tok-p">)</span><span class="tok-n">t</span><span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">int128_t</span><span class="tok-p">)</span><span class="tok-n">t</span><span class="tok-p">)</span><span class="tok-w">   </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">62</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x4</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x6</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x4</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x8</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x6</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x10</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x8</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x12</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x14</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x12</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>

<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">uint64_t</span><span class="tok-p">)</span><span class="tok-n">INT64_MAX</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x4</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x6</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x8</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x12</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x14</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">6</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>

<span class="tok-w">	</span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;re exploiting the fact that modern compilers offer support for the
types <code><em>int128</code> and <code>unsigned </em>int128</code>, which we don&#8217;t really use fully: we
only care about the upper half of the result which on x86_64 gets stored in
<code>rdx</code> after a multiplication.</p>
</div>
<div class="paragraph">
<p>Now all our multiplications are between numbers in the range \([0,2^{64})\),
there&#8217;s no integer division in sight and&#8230;&#8203; wait, what&#8217;s that?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-n">icos</span><span class="tok-p">(</span><span class="tok-n">INT64_MIN</span><span class="tok-p">);</span>
<span class="tok-mi">9223372036854775808</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Yeah uhm, it turns out that <code>((int128_t)INT64_MIN * (int128_t)INT64_MIN) &gt;&gt; 62</code> is exactly <code>UINT64_MAX + 1</code>,
and it makes us overflow. For reference, <code>INT64_MIN</code> was one of our sample points and the correct value there was
<code>6521908912666391106</code>.</p>
</div>
<div class="paragraph">
<p>The fix is pretty easy, just subtract 1 from <code>x2</code> if <code>t==INT64_MIN</code> to take it back in the representable range of
<code>uint64_t</code>. We will verify that the error introduced this way is negligible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-nf">icos</span><span class="tok-p">(</span><span class="tok-kt">int64_t</span><span class="tok-w"> </span><span class="tok-n">t</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">	</span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">		</span><span class="tok-mi">2844719788994575527</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">146230515361076815</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">3006744454122068</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">33119841825907</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">226999764641</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">1060732338</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">3557527</span><span class="tok-p">,</span>
<span class="tok-w">	</span><span class="tok-p">};</span>

<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x2</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(((</span><span class="tok-n">int128_t</span><span class="tok-p">)</span><span class="tok-n">t</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">int128_t</span><span class="tok-p">)</span><span class="tok-n">t</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">62</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-o">==</span><span class="tok-n">INT64_MIN</span><span class="tok-p">);</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x4</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x6</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x4</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x8</span><span class="tok-w">  </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x6</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x10</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x8</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x12</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x14</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x12</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>

<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">uint64_t</span><span class="tok-p">)</span><span class="tok-n">INT64_MAX</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x4</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x6</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x8</span><span class="tok-w">  </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x12</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x14</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">6</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>

<span class="tok-w">	</span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reducing_computation_cost">Reducing computation cost</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have a formula to evaluate, we need to worry about doing so efficiently. currently, we are calculating
all powers of <code>t</code> up front, and then summing them all together for a total of 14 multiplications and 7 additions,
but there is a trick to evaluating long polynomials with less operations. We consider the evaluation formula we
settled for (\(\bar{c}_j\) will be the integer coefficients we chose) and factor out \(x_2\) in a few places
(remember that \(x_{2n+2} = x_{2n} \cdot x_2 \cdot 2^{-64}\)).</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align}
\text{icos}(t) = 2^{63}
&amp;- \frac{x_2    \cdot \bar{c}_0}{2^{64}}
+ \frac{x_4    \cdot \bar{c}_1}{2^{64}}
- \frac{x_6    \cdot \bar{c}_2}{2^{64}}
+ \frac{x_8    \cdot \bar{c}_3}{2^{64}}
- \frac{x_{10} \cdot \bar{c}_4}{2^{64}}
+ \frac{x_{12} \cdot \bar{c}_5}{2^{64}}
- \frac{x_{14} \cdot \bar{c}_6}{2^{64}}\\
= 2^{63} &amp;- \frac{x_2}{2^{64}}\left(
    \bar{c}_0 - \frac{x_2}{2^{64}}\left(
        \bar{c}_1 - \frac{x_2}{2^{64}}\left(
            \bar{c}_2 - \frac{x_2}{2^{64}}\left(
                \bar{c}_3 - \frac{x_2}{2^{64}}\left(
                    \bar{c}_4 - \frac{x_2}{2^{64}}\left(
                        \bar{c}_5 - \frac{x_2}{2^{64}}\bar{c}_6
                    \right)
                \right)
            \right)
        \right)
    \right)
\right)
\end{align}\]
</div>
</div>
<div class="paragraph">
<p>This way we only need to perform 8 multiplications (one is hidden in \(x_2\)'s definition)
and 7 additions. In practice we implement this in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-nf">icos</span><span class="tok-p">(</span><span class="tok-kt">int64_t</span><span class="tok-w"> </span><span class="tok-n">t</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">	</span><span class="tok-k">static</span><span class="tok-w"> </span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">		</span><span class="tok-mi">2844719788994575527</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">146230515361076815</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">3006744454122068</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">33119841825907</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">226999764641</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">1060732338</span><span class="tok-p">,</span>
<span class="tok-w">		</span><span class="tok-mi">3557527</span><span class="tok-p">,</span>
<span class="tok-w">	</span><span class="tok-p">};</span>

<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(((</span><span class="tok-n">int128_t</span><span class="tok-p">)</span><span class="tok-n">t</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">int128_t</span><span class="tok-p">)</span><span class="tok-n">t</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">62</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-o">==</span><span class="tok-n">INT64_MIN</span><span class="tok-p">);</span>

<span class="tok-w">	</span><span class="tok-kt">uint64_t</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">6</span><span class="tok-p">])</span><span class="tok-w">       </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)</span><span class="tok-n">x2</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">uint128_t</span><span class="tok-p">)(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-mi">64</span><span class="tok-p">;</span>
<span class="tok-w">	</span><span class="tok-k">return</span><span class="tok-w">  </span><span class="tok-p">(</span><span class="tok-mi">1ULL</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-w"> </span><span class="tok-mi">63</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">res</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Doing this changes the digit in last place for some of the values, but this formula should be more accurate overall,
so we&#8217;re not too worried about that. We will do some better error analysis later.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-02 19:42:09 +0200
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>